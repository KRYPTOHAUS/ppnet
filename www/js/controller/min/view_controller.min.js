app.controller("ViewController",["$scope","$routeParams","$rootScope",function(e,o,n){function t(){return current_date=new Date,current_day_hours=current_date.getHours(),current_day_minutes=current_date.getMinutes(),60*current_day_hours*60+60*current_day_minutes}function i(o,n,t,s,a){if(img=e.remoteCouch+"/"+o+"/image",e.cache)ImgCache.isCached(img,function(p,r){if(r){if(filename=ImgCache.getShaaaaatFilename(p),filepath=ImgCache.getCacheFolderURI(),content='<img src="'+filepath+"/"+filename+'" id="'+o+'">',"undefined"!=typeof timeline&&(content='<a class="magnific-popup" href="'+filepath+"/"+filename+'">'+content+"</a>",e.global_functions.pushToTimeline(n,content)),"undefined"!=typeof l&&(content='<div class="mashup_item"><div class="mashup_img">'+content+"</div></div>",l.prepend(content).isotope("reloadItems").isotope({sortBy:"original-order"}),l.find("img#"+o).load(function(){l.isotope("layout")})),d){content='<img width="150px" height="auto" src="'+filepath+"/"+filename+'" id="'+o+'">';{L.marker([t,s]).addTo(c).bindPopup('<span style="color: #bf004d;">'+a+"</span><br>"+content)}}}else ImgCache.cacheFile(img,function(){i(o,n,t,s,a)})});else if(content='<img height="auto" src="'+img+'" id="'+o+'">',"undefined"!=typeof l&&(content='<div class="mashup_item"><div class="mashup_img">'+content+"</div></div>",l.prepend(content).isotope("reloadItems").isotope({sortBy:"original-order"}),l.find("img#"+o).load(function(){l.isotope("layout")})),"undefined"!=typeof timeline&&e.global_functions.pushToTimeline(n,content),d){content='<img width="150px" height="auto" src="'+img+'" id="'+o+'">';{L.marker([t,s]).addTo(c).bindPopup('<span style="color: #bf004d;">'+a+"</span><br>"+content)}}}"undefined"!=typeof timeline&&delete timeline;var s=Math.floor(1e3*Math.random()),a="PostingController"+s;n.activeController="PostingController"+s;var c,p=new Object,d=!1,r=window.innerHeight-130;e.timelineoptions={width:"100%",minHeight:500,height:r+"px",style:"box",cluster:!0,axisOnTop:!0,animate:!1,zoomMin:6e4,zoomMax:12096e5},n.postingPossible=!1,e.global_functions=e.global_functions?e.global_functions:{},e.posting={},e.posting_functions={},e.postings=[],e.comment={},e.comment_functions={},e.comments={},e.like={},e.like_functions={},e.likes={},e.types={},e.image_posts=[],e.apply=function(){e.$$phase||e.$apply()},e.db.info(function(o,t){p[s]=e.db.changes({continuous:!0,include_docs:!0,since:t.update_seq,onChange:function(o){if(console.log("onChange"),a!=n.activeController)return p[s].cancel(),void 0;switch(e.types[o.id]&&e.types[o.id].type&&!o.doc.type&&(o.doc.type=e.types[o.id].type),o.doc.type){case"POST":e.posting_functions.onChange(o);break;case"LIKE":e.like_functions.onChange(o);break;case"COMMENT":e.comment_functions.onChange(o)}},complete:function(){}})}),e.posting_functions.onChange=function(o){o.deleted?angular.forEach(e.postings,function(n,t){n.id==o.id&&e.postings.splice(t,1)}):e.types[o.id]||o.doc.image&&!o.doc._attachments||(o.doc.image&&o.doc._attachments?(e.types[o.id]={type:"POST"},e.likes[o.id]=new Array,o.doc.user.id==e.user.getId()&&e.images[o.id]&&(o.temp_img=e.images[o.id]),"undefined"!=typeof timeline?(console.log("timeline"),e.global_functions.prepareForTimeline(o.doc)):d?(console.log("mapview"),console.log(o.doc),e.addMarkerToMap(o.doc)):e.image_posts&&i(o.id,o.doc.created),e.postings&&e.postings.push(o),e.apply()):(e.types[o.id]={type:"POST"},e.likes[o.id]=new Array,e.postings.push(o),"undefined"!=typeof timeline?(console.log("timeline"),e.global_functions.prepareForTimeline(o.doc)):d&&(console.log("mapview"),e.addMarkerToMap(o.doc)))),e.apply()},e.posting_functions.isPost=function(e){"POST"==e.type&&emit([e._id,0],e),"LIKE"==e.type&&emit([e.posting,1],e),"COMMENT"==e.type&&emit([e.posting,2],e)},e.time=function(e){return e/=1e3},e.posting_functions.showTimestamp=function(e){return maxTimeDifferenceForToday=Math.round((new Date).getTime()/1e3)-t(),maxTimeDifferenceForYesterday=maxTimeDifferenceForToday-86400,postTime=e.doc.created/1e3,postTime>maxTimeDifferenceForYesterday&&maxTimeDifferenceForToday>postTime?"yesterday":maxTimeDifferenceForToday>postTime?"older":"today"},e.like_functions.createToScope=function(o){e.types[o.id]={type:"LIKE",posting:o.doc.posting},e.likes[o.doc.posting]||(e.likes[o.doc.posting]=new Array),e.likes[o.doc.posting].push(o),e.apply()},e.like_functions.deleteFromScope=function(o){e.types[o]&&angular.forEach(e.likes[e.types[o].posting],function(n,t){n.id==o&&(e.likes[e.types[o].posting].splice(t,1),e.apply())})},e.like_functions.onChange=function(o){o.deleted?e.likes[e.types[o.id].posting]&&e.like_functions.deleteFromScope(o.id):(e.likes[o.doc.posting]&&angular.forEach(e.likes[o.doc.posting],function(n){o.doc.user.id==e.user.getId()&&e.like_functions.deleteFromScope(n._id)}),e.like_functions.createToScope(o))},e.comment_functions.showComments=function(o){return e.comments[o]?!0:!1},e.comment_functions.deleteFromScope=function(o){angular.forEach(e.comments[e.types[o].posting],function(n,t){n.id==o&&(e.comments[e.types[o].posting].splice(t,1),e.apply())})},e.comment_functions.onChange=function(o){o.deleted?e.comment_functions.deleteFromScope(o.id):(e.types[o.id]={type:"COMMENT",posting:o.doc.posting},e.comments[o.doc.posting]||(e.comments[o.doc.posting]=new Array),e.comments[o.doc.posting].push(o),e.apply())},e.global_functions.showLoader=function(){return l||timeline||e.postings.length>=1?!1:!0},e.global_functions.orderByCreated=function(e){return e.created?e.created:e.doc.created},e.postings||(e.postings=[]),e.global_functions.showWall=function(){e.db.query({map:e.posting_functions.isPost},{reduce:!0},function(o,n){e.postings=[],e.likes={},e.comments={},e.types={},e.response=n;var t=0;angular.forEach(n.rows,function(o){if(t++,o.value&&(o.doc=o.value,delete o.value),o.doc.created)switch(o.doc.type){case"POST":e.types[o.id]={type:"POST"},e.postings.push(o),"undefined"!=typeof timeline?e.global_functions.prepareForTimeline(o.doc):d&&e.addMarkerToMap(o.doc),e.likes[o.id]||(e.likes[o.id]=new Array),e.comments[o.id]||(e.comments[o.id]=new Array);break;case"LIKE":if(e.types[o.id]||(e.types[o.id]=new Array),e.types[o.id]={type:"LIKE",posting:o.doc.posting},!e.likes[o.doc.posting])break;e.likes[o.doc.posting].push(o);break;case"COMMENT":if(e.types[o.id]||(e.types[o.id]=new Array),e.types[o.id]={type:"COMMENT",posting:o.doc.posting},!e.comments[o.doc.posting])break;e.comments[o.doc.posting].push(o)}e.apply(),n.rows.length==t})})},e.loadMapView=function(){d=!0,jQuery("#map").css("height",r+"px"),c=L.map("map").setView([50.9188,6.9242],15),L.tileLayer("http://{s}.tile.cloudmade.com/c89f01daa9684630881b71ece61c646c/997/256/{z}/{x}/{y}.png",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',maxZoom:18}).addTo(c)},e.addMarkerToMap=function(e){if(null!=e.coords.longitude)if(e.image)i(e._id,e.created,e.coords.latitude,e.coords.longitude,e.user.name);else{L.marker([e.coords.latitude,e.coords.longitude]).addTo(c).bindPopup('<span style="color: #bf004d;">'+e.user.name+"</span><br>"+e.msg)}},e.timelineZoomIn=function(){timeline.zoom(1)},e.timelineZoomOut=function(){timeline.zoom(-1)},e.centerNow=function(){timeline.setVisibleChartRangeNow()},e.global_functions.loadTimeline=function(){new Date;angular.forEach(e.postings,function(o){e.global_functions.prepareForTimeline(o.doc)})},e.global_functions.prepareForTimeline=function(o){var n=new Date(o.created);""!=o.msg.trim()&&e.global_functions.pushToTimeline(n,o.msg),o.image&&i(o._id,n)},e.global_functions.pushToTimeline=function(e,o){"undefined"!=typeof timeline&&timeline.addItem({start:e,end:"",content:o+"<br>",editable:!1}),$("a.magnific-popup").magnificPopup({type:"image",closeOnContentClick:!0,closeBtnInside:!0})},e.hasImage=function(e){e.image&&emit([e._id,0],e)},e.queryImagePosts=function(){e.loadIsotope(),e.db.query({map:e.hasImage},{reduce:!0},function(o,n){e.response=n,angular.forEach(n.rows,function(o,t){if(o.value&&(o.doc=o.value,delete o.value),o.doc.created&&"POST"===o.doc.type){var s=0;n.rows.length-1==t&&(s=1),i(o.doc._id,o.doc.created,s)}e.apply()})})};var l;e.loadIsotope=function(){l||(l=$(".mashup_wrapper"),l.isotope({itemSelector:".mashup_item",masonry:{columnWidth:100}}),l.isotope("layout"),l.on("click",".mashup_item",function(){$(this).toggleClass("highlight"),l.isotope("layout")}))},e.apply()}]);